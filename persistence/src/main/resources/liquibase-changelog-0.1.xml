<!--
    Copyright (c) 2015 Development Gateway, Inc and others.

    All rights reserved. This program and the accompanying materials
    are made available under the terms of the MIT License (MIT)
    which accompanies this distribution, and is available at
    https://opensource.org/licenses/MIT

    Contributors:
    Development Gateway - initial API and implementation
-->
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd">
    
    <changeSet id="ANACIM-1 initial org and admin" author="nmandrescu">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="person" />
            <columnExists tableName="person" columnName="organization_id" />
            <tableExists tableName="role" />
            <tableExists tableName="person_roles" />
            <tableExists tableName="organization" />
        </preConditions>
        <insert tableName="organization">
            <column name="id" valueSequenceNext="hibernate_sequence" />
            <column name="tag" value="ANACIM" />
            <column name="label" value="ANACIM" />
        </insert>
        <insert tableName="person">
            <column name="id" valueSequenceNext="hibernate_sequence" />
            <column name="username" value="admin" />
            <column name="email" value="admin@developmentgateway.org" />
            <column name="enabled" value="true" />
            <column name="password" value="$2a$10$wvn/WOzcIGu.GGFGDhEzS.0KVIhHG3ypCNjH4ui1Xa8h3qgt2mdZ6" />
        </insert>
        <insert tableName="role">
            <column name="id" valueSequenceNext="hibernate_sequence" />
            <column name="authority" value="ROLE_ADMIN" />
            <column name="label" value="Administrateur" />
        </insert>
        <sql><![CDATA[
            INSERT INTO person_roles(person_id, roles_id)
            SELECT p.id, r.id
            FROM person p,
                 role r
            WHERE p.username = 'admin'
              AND r.authority = 'ROLE_ADMIN';
        ]]></sql>
        <sql><![CDATA[
            UPDATE person
            SET organization_id=org.id
            FROM organization org
            WHERE person.username = 'admin'
              AND org.tag = 'ANACIM';
        ]]></sql>
    </changeSet>

    <changeSet id="ANACIM-15 rain indicators metadata" author="nmandrescu">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="indicator_metadata" />
            <changeSetExecuted id="ANACIM-1 initial org and admin" author="nmandrescu"
                               changeLogFile="liquibase-changelog-0.1.xml"/>
        </preConditions>
        <insert tableName="indicator_metadata">
            <column name="id" valueSequenceNext="hibernate_sequence" />
            <column name="name" value="Cumul de pluie" />
            <column name="type" value="RAINFALL" />
            <column name="organization_id" valueComputed="(SELECT id FROM organization WHERE tag='ANACIM')" />
        </insert>
        <insert tableName="indicator_metadata">
            <column name="id" valueSequenceNext="hibernate_sequence" />
            <column name="name" value="Démarrage de la saison des pluies" />
            <column name="type" value="RAINFALL_SEASON" />
            <column name="organization_id" valueComputed="(SELECT id FROM organization WHERE tag='ANACIM')" />
        </insert>
    </changeSet>

    <changeSet id="ANACIM-15 other organizations" author="nmandrescu">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="organization" />
        </preConditions>
        <insert tableName="organization">
            <column name="id" valueSequenceNext="hibernate_sequence" />
            <column name="tag" value="CSA" />
            <column name="label" value="CSA" />
        </insert>
        <insert tableName="organization">
            <column name="id" valueSequenceNext="hibernate_sequence" />
            <column name="tag" value="CSE" />
            <column name="label" value="CSE" />
        </insert>
        <insert tableName="organization">
            <column name="id" valueSequenceNext="hibernate_sequence" />
            <column name="tag" value="DGPRE" />
            <column name="label" value="DGPRE" />
        </insert>
        <insert tableName="organization">
            <column name="id" valueSequenceNext="hibernate_sequence" />
            <column name="tag" value="DPV" />
            <column name="label" value="DPV" />
        </insert>
        <insert tableName="organization">
            <column name="id" valueSequenceNext="hibernate_sequence" />
            <column name="tag" value="MAE" />
            <column name="label" value="MAE" />
        </insert>
        <insert tableName="organization">
            <column name="id" valueSequenceNext="hibernate_sequence" />
            <column name="tag" value="ME" />
            <column name="label" value="Ministère de l'élevage" />
        </insert>
    </changeSet>

    <changeSet id="ANACIM-14 editor role" author="nmandrescu">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="role" />
        </preConditions>
        <insert tableName="role">
            <column name="id" valueSequenceNext="hibernate_sequence" />
            <column name="authority" value="ROLE_EDITOR" />
            <column name="label" value="Editeur" />
        </insert>
    </changeSet>

    <changeSet id="ANACIM-33 locations dataset" author="nmandrescu">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="zone" />
            <tableExists tableName="region" />
            <tableExists tableName="department" />
        </preConditions>
        <sqlFile path="sql/locations.sql" />
    </changeSet>

    <changeSet id="ANACIM-19 pluviometric posts" author="nmandrescu">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="department" />
            <tableExists tableName="pluviometric_post" />
            <changeSetExecuted id="ANACIM-33 locations dataset" author="nmandrescu"
                               changeLogFile="liquibase-changelog-0.1.xml"/>
        </preConditions>
        <sqlFile path="sql/pluviometric-post.sql" />
    </changeSet>

    <changeSet id="ANACIM-24 starting year" author="nmandrescu">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="admin_settings" />
        </preConditions>
        <insert tableName="admin_settings">
            <column name="id" valueSequenceNext="hibernate_sequence" />
            <column name="starting_year" value="2019" />
        </insert>
    </changeSet>

    <changeSet id="ANACIM-51 rain seasons references" author="nmandrescu">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="rain_season_start_reference" />
        </preConditions>
        <insert tableName="rain_season_start_reference">
            <column name="id" valueSequenceNext="hibernate_sequence" />
            <column name="reference_year_start" value="1981" />
            <column name="reference_year_end" value="2010" />
            <column name="year_start" value="1981" />
            <column name="year_end" value="2020" />
        </insert>
        <insert tableName="rain_season_start_reference">
            <column name="id" valueSequenceNext="hibernate_sequence" />
            <column name="reference_year_start" value="1991" />
            <column name="reference_year_end" value="2020" />
            <column name="year_start" value="2021" />
            <column name="year_end" value="2029" />
        </insert>
        <insert tableName="rain_season_start_reference">
            <column name="id" valueSequenceNext="hibernate_sequence" />
            <column name="reference_year_start" value="2001" />
            <column name="reference_year_end" value="2030" />
            <column name="year_start" value="2031" />
            <column name="year_end" value="2039" />
        </insert>
        <insert tableName="rain_season_start_reference">
            <column name="id" valueSequenceNext="hibernate_sequence" />
            <column name="reference_year_start" value="2011" />
            <column name="reference_year_end" value="2040" />
            <column name="year_start" value="2041" />
            <column name="year_end" value="2049" />
        </insert>
    </changeSet>

</databaseChangeLog>
